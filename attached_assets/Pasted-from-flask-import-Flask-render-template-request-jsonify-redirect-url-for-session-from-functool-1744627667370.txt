from flask import Flask, render_template, request, jsonify, redirect, url_for, session
from functools import wraps
import json
import secrets
from datetime import datetime, timedelta
import google.generativeai as genai 
import os

app = Flask(__name__)
app.secret_key = os.urandom(24)

# Configure Gemini API
GOOGLE_API_KEY = "AIzaSyBrFEI0JTDLrQyU7sFqV9HPsAKt6ht9840"  # Replace with your actual API key
genai.configure(api_key=GOOGLE_API_KEY)
model = genai.GenerativeModel('gemini-2.0-flash')

# Temporary data storage (replace with database in production)
doctors = [
    {"id": 1, "name": "Dr. Smith", "specialization": "Cardiologist", "email": "dr.smith@example.com"},
    {"id": 2, "name": "Dr. Johnson", "specialization": "Dermatologist", "email": "dr.johnson@example.com"}
]

patients = [
    {"id": 1, "name": "John Doe", "email": "john@example.com"},
    {"id": 2, "name": "Jane Smith", "email": "jane@example.com"}
]

# Temporary user credentials
users = {
    "dr.smith@example.com": {"password": "password123", "type": "doctor", "id": 1},
    "dr.johnson@example.com": {"password": "password123", "type": "doctor", "id": 2},
    "john@example.com": {"password": "password123", "type": "patient", "id": 1},
    "jane@example.com": {"password": "password123", "type": "patient", "id": 2}
}

# Temporary appointments data
appointments = [
    {
        "id": 1,
        "patient": "john@example.com",
        "doctor": "dr.smith@example.com",
        "date": "2024-03-20",
        "time": "10:00",
        "status": "scheduled",
        "reason": "Regular checkup"
    },
    {
        "id": 2,
        "patient": "jane@example.com",
        "doctor": "dr.smith@example.com",
        "date": "2024-03-21",
        "time": "14:30",
        "status": "scheduled",
        "reason": "Consultation"
    },
    {
        "id": 3,
        "patient": "john@example.com",
        "doctor": "dr.johnson@example.com",
        "date": "2024-03-22",
        "time": "11:00",
        "status": "scheduled",
        "reason": "Skin check"
    }
]

# Login required decorator
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

@app.route('/')
def home():
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    return redirect(url_for('login'))

@app.route('/login', methods=['GET'])
def login():
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    return render_template('login.html')

@app.route('/register', methods=['GET'])
def register_page():
    if 'user_id' in session:
        return redirect(url_for('dashboard'))
    return render_template('register.html')

@app.route('/api/register', methods=['POST'])
def register():
    try:
        data = request.json
        email = data.get('email')
        password = data.get('password')
        name = data.get('name')
        user_type = data.get('type')
        
        # Validate required fields
        if not all([email, password, name, user_type]):
            return jsonify({
                'success': False,
                'message': 'All fields are required'
            }), 400
        
        # Check if email already exists
        if email in users:
            return jsonify({
                'success': False,
                'message': 'Email already registered'
            }), 400

        if user_type == 'doctor':
            specialization = data.get('specialization')
            if not specialization:
                return jsonify({
                    'success': False,
                    'message': 'Specialization is required for doctors'
                }), 400
                
            # Create new doctor
            new_doctor = {
                "id": len(doctors) + 1,
                "name": name,
                "specialization": specialization,
                "email": email,
                "role": "doctor"
            }
            doctors.append(new_doctor)
            users[email] = {
                'password': password,
                'type': 'doctor',
                'id': new_doctor['id']
            }
        else:
            # Create new patient
            new_patient = {
                "id": len(patients) + 1,
                "name": name,
                "email": email,
                "role": "patient"
            }
            patients.append(new_patient)
            users[email] = {
                'password': password,
                'type': 'patient',
                'id': new_patient['id']
            }
        
        # Automatically log in the user
        session['user_id'] = email
        session['user_type'] = user_type
        
        return jsonify({
            'success': True,
            'redirect': '/dashboard'
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'Registration failed: {str(e)}'
        }), 500

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('home'))

@app.route('/dashboard')
@login_required
def dashboard():
    user_email = session.get('user_id')
    user_type = session.get('user_type')
    
    # Get user data based on type
    if user_type == 'doctor':
        user_data = next((doc for doc in doctors if doc.get('email') == user_email), None)
        # Get doctor's appointments
        user_appointments = [appt for appt in appointments if appt['doctor'] == user_email]
    else:
        user_data = next((pat for pat in patients if pat.get('email') == user_email), None)
        # Get patient's appointments
        user_appointments = [appt for appt in appointments if appt['patient'] == user_email]
    
    if not user_data:
        return redirect('/login')
    
    return render_template('dashboard.html', 
                         user_data=user_data, 
                         user_type=user_type,
                         appointments=user_appointments)

@app.route('/symptom-checker', methods=['GET', 'POST'])
@login_required
def symptom_checker():
    if request.method == 'POST':
        try:
            data = request.json
            symptoms = data.get('symptoms', '')
            age = data.get('age', '')
            gender = data.get('gender', '')
            duration = data.get('duration', '')
            severity = data.get('severity', '')
            medical_history = data.get('medical_history', '')
            
            prompt = f"""As a medical AI assistant, analyze the following patient information:

Patient Information:
- Age: {age}
- Gender: {gender}
- Symptoms: {symptoms}
- Duration: {duration}
- Severity: {severity}
- Medical History: {medical_history}

Please provide a comprehensive analysis with the following structure:

Possible Conditions:
[List each condition with confidence level and brief description]
- Condition (High/Medium/Low confidence): Description and typical presentation

Key Symptoms Analysis:
- [Analyze each reported symptom and its significance]

Risk Factors:
- [List relevant risk factors based on patient's profile]

Recommended Next Steps:
1. [Immediate actions or self-care measures]
2. [When to seek professional medical care]
3. [Suggested medical tests or examinations]

Warning Signs:
- [List specific symptoms or changes that require immediate medical attention]

Preventive Measures:
1. [Lifestyle modifications]
2. [Preventive actions]
3. [General health recommendations]

Note: This is an AI-generated analysis for informational purposes only. Please consult with a healthcare provider for proper medical diagnosis and treatment."""

            response = model.generate_content(prompt)
            
            if not response or not response.text:
                return jsonify({
                    'success': False,
                    'message': 'No response received from AI. Please try again.'
                }), 500
            
            processed_response = response.text.replace("*", "").replace("â€¢", "")
            
            sections = [
                "Possible Conditions:",
                "Key Symptoms Analysis:",
                "Risk Factors:",
                "Recommended Next Steps:",
                "Warning Signs:",
                "Preventive Measures:"
            ]
            
            formatted_response = processed_response
            for section in sections:
                if section not in formatted_response:
                    base_section = section.replace(":", "")
                    formatted_response = formatted_response.replace(base_section, section)
            
            return jsonify({
                'success': True,
                'analysis': formatted_response
            })
            
        except Exception as e:
            app.logger.error(f"Symptom checker error: {str(e)}")
            return jsonify({
                'success': False,
                'message': 'An error occurred while analyzing symptoms. Please try again.'
            }), 500
    
    return render_template('symptom_checker.html')

@app.route('/profile')
@login_required
def profile():
    user_type = session.get('user_type')
    user_email = session.get('user_id')
    
    if not user_type or not user_email:
        session.clear()
        return redirect(url_for('login'))
    
    if user_type == 'doctor':
        user_data = next((doc for doc in doctors if doc.get('email') == user_email), None)
    else:
        user_data = next((pat for pat in patients if pat.get('email') == user_email), None)
    
    if not user_data:
        session.clear()
        return redirect(url_for('login'))
    
    return render_template('profile.html', user_type=user_type, user_data=user_data)

@app.route('/api/profile', methods=['PUT'])
@login_required
def update_profile():
    user_email = session.get('user_id')
    data = request.json
    
    if not user_email:
        return jsonify({'success': False, 'message': 'User not logged in'}), 401
    
    # Update user data
    if session['user_type'] == 'doctor':
        doctor = next((doc for doc in doctors if doc.get('email') == user_email), None)
        if doctor:
            doctor.update({
                'name': data.get('name', doctor['name']),
                'contact': data.get('contact', doctor['contact']),
                'specialization': data.get('specialization', doctor['specialization']),
                'location': data.get('location', doctor['location'])
            })
    else:
        patient = next((pat for pat in patients if pat.get('email') == user_email), None)
        if patient:
            patient.update({
                'name': data.get('name', patient['name']),
                'contact': data.get('contact', patient['contact'])
            })
    
    # Update password if provided
    if data.get('newPassword'):
        if users[user_email]['password'] != data.get('currentPassword'):
            return jsonify({'success': False, 'message': 'Current password is incorrect'}), 400
        users[user_email]['password'] = data['newPassword']
    
    return jsonify({'success': True})

@app.route('/book-appointment', methods=['GET', 'POST'])
@login_required
def book_appointment():
    if request.method == 'POST':
        data = request.form
        patient_email = session.get('user_id')
        
        # Create new appointment
        new_appointment = {
            "id": len(appointments) + 1,
            "patient": patient_email,
            "doctor": data.get('doctor'),
            "date": data.get('date'),
            "time": data.get('time'),
            "status": "scheduled",
            "reason": data.get('reason')
        }
        
        appointments.append(new_appointment)
        return redirect(url_for('dashboard'))
    
    return render_template('book_appointment.html', doctors=doctors)

@app.route('/api/doctors')
@login_required
def get_doctors():
    return jsonify(doctors)

@app.route('/api/appointments', methods=['GET'])
@login_required
def get_appointments():
    user_email = session.get('user_id')
    user_type = session.get('user_type')
    
    if user_type == 'doctor':
        user_appointments = [apt for apt in appointments if apt['doctor'] == user_email]
    else:
        user_appointments = [apt for apt in appointments if apt['patient'] == user_email]
    
    return jsonify(user_appointments)

@app.route('/api/appointments', methods=['POST'])
@login_required
def create_appointment():
    if session.get('user_type') != 'patient':
        return jsonify({'success': False, 'message': 'Only patients can book appointments'}), 403
    
    data = request.json
    patient_email = session.get('user_id')
    
    # Validate doctor exists
    if not any(doc['email'] == data['doctor'] for doc in doctors):
        return jsonify({'success': False, 'message': 'Doctor not found'}), 404
    
    # Check for conflicting appointments
    conflicting_appointment = next(
        (apt for apt in appointments 
         if apt['doctor'] == data['doctor'] 
         and apt['date'] == data['date'] 
         and apt['time'] == data['time']),
        None
    )
    
    if conflicting_appointment:
        return jsonify({'success': False, 'message': 'Time slot already booked'}), 400
    
    appointment = {
        'id': len(appointments) + 1,
        'doctor': data['doctor'],
        'patient': patient_email,
        'date': data['date'],
        'time': data['time'],
        'reason': data['reason'],
        'status': 'scheduled'
    }
    
    appointments.append(appointment)
    return jsonify({'success': True, 'appointment': appointment})

@app.route('/api/login', methods=['POST'])
def api_login():
    try:
        data = request.json
        email = data.get('email')
        password = data.get('password')
        
        if not email or not password:
            return jsonify({
                'success': False,
                'message': 'Email and password are required'
            }), 400
        
        user = users.get(email)
        if not user or user['password'] != password:
            return jsonify({
                'success': False,
                'message': 'Invalid email or password'
            }), 401
        
        session['user_id'] = email
        session['user_type'] = user['type']
        
        return jsonify({
            'success': True,
            'redirect': '/dashboard'
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'Login failed: {str(e)}'
        }), 500

if __name__ == '__main__':
    app.run(debug=True, port=280)